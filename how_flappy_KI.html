<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KI Labor - Flappy Learns to Fly</title>
    <style>
        :root {
            --bg-color: #0a0a0a;
            --green: #00ff41;
            --blue: #00f3ff;
            --red: #ff0055;
            --yellow: #ffdd00;
            --panel-bg: #1a1a1a;
        }

        * { 
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: #eee;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }

        /* HEADER - Kompakt */
        header {
            text-align: center;
            padding: 15px 10px;
            background: linear-gradient(135deg, #000 0%, #1a1a1a 100%);
            border-bottom: 3px solid var(--green);
            margin-bottom: 10px;
        }
        
        h1 {
            color: var(--green);
            font-family: monospace;
            font-size: 1.5rem;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        }
        
        .subtitle { 
            font-size: 0.85rem; 
            color: #888;
            margin-top: 5px;
        }

        /* SCORE BOARD - Sticky */
        .score-board {
            position: sticky;
            top: 0;
            z-index: 100;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            background: var(--panel-bg);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.8);
        }
        
        .stat-box {
            text-align: center;
            padding: 10px 5px;
            background: #000;
            border-radius: 6px;
            border: 2px solid #333;
        }
        
        .label { 
            font-size: 0.65rem; 
            color: #888; 
            text-transform: uppercase;
            margin-bottom: 5px;
            display: block;
        }
        
        .value { 
            font-size: 1.4rem; 
            font-weight: bold; 
            color: #fff; 
            font-family: monospace;
        }
        
        .hl { 
            color: var(--green);
            text-shadow: 0 0 8px rgba(0, 255, 65, 0.6);
        }

        /* GAME AREA - VIEL GR√ñ√üER mit mehr Raum! */
        .game-wrapper {
            position: relative;
            background: #000;
            border: 4px solid #333;
            border-radius: 12px;
            overflow: hidden;
            height: 750px;
            width: 100%;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            padding: 10px;
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        
        canvas#gameCanvas { 
            width: 100%; 
            height: 100%; 
            display: block;
            cursor: pointer;
        }

        .brain-hud {
            position: absolute;
            top: 15px; 
            right: 15px;
            width: 210px;
            height: 195px;
            background: rgba(0, 0, 0, 0.95);
            border: 3px solid var(--blue);
            border-radius: 8px;
            padding: 8px;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.3);
        }
        
        .brain-title {
            color: var(--blue);
            font-family: monospace;
            font-size: 8px;
            text-transform: uppercase;
            border-bottom: 1px solid #333;
            text-align: center;
            padding-bottom: 3px;
            margin-bottom: 5px;
        }
        
        #netCanvas { 
            display: block;
            margin: 0 auto;
        }

        /* CONTROLS - Kompakt */
        .controls-panel {
            background: var(--panel-bg);
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid var(--blue);
            margin-bottom: 15px;
        }
        
        .controls-panel h3 { 
            margin: 0 0 15px 0; 
            color: var(--blue); 
            font-size: 1.1rem;
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }

        .control-group { 
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #333;
        }
        
        label { 
            font-size: 0.85rem; 
            color: #ddd; 
            display: flex; 
            justify-content: space-between;
            margin-bottom: 6px;
        }
        
        input[type=range] { 
            width: 100%; 
            cursor: pointer; 
            accent-color: var(--green);
        }
        
        input[type=text], input[type=number] {
            width: 100%;
            padding: 8px;
            background: #000;
            border: 2px solid #333;
            border-radius: 4px;
            color: var(--green);
            font-family: monospace;
            font-size: 0.85rem;
        }
        
        input[type=text]:focus, input[type=number]:focus {
            outline: none;
            border-color: var(--green);
        }
        
        .btn-row { 
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 12px;
        }
        
        button {
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            font-family: monospace;
            transition: all 0.2s ease;
            font-size: 0.85rem;
        }
        
        .btn-start { 
            background: linear-gradient(135deg, var(--green), #00cc33);
            color: #000;
        }
        
        .btn-start:hover, .btn-start:active { 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 65, 0.5);
        }
        
        .btn-reset { 
            background: #333;
            color: var(--red);
            border: 2px solid var(--red);
        }
        
        .btn-reset:hover, .btn-reset:active { 
            background: var(--red);
            color: #fff;
        }
        
        .btn-theme {
            background: #444;
            color: #fff;
            border: 1px solid #666;
            margin-top: 5px;
            width: 100%;
            padding: 8px;
        }
        
        .btn-theme:hover {
            background: #555;
        }

        /* SECTION TOGGLE */
        .section-toggle {
            background: var(--panel-bg);
            border: 2px solid var(--green);
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        .toggle-header {
            background: #222;
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        
        .toggle-header:active {
            background: #2a2a2a;
        }
        
        .toggle-header h3 {
            margin: 0;
            color: var(--green);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .toggle-icon {
            color: var(--green);
            font-size: 1.2rem;
            font-weight: bold;
            transition: transform 0.3s ease;
        }
        
        .section-toggle.active .toggle-icon {
            transform: rotate(180deg);
        }
        
        .toggle-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }
        
        .section-toggle.active .toggle-content {
            max-height: 5000px;
        }
        
        .toggle-content-inner {
            padding: 15px;
        }

        /* CONTENT STYLING */
        .info-text {
            color: #ccc;
            font-size: 0.95rem;
            line-height: 1.7;
        }
        
        .info-text p { 
            margin-bottom: 15px; 
        }
        
        .info-text strong { 
            color: #fff;
        }
        
        .hl-green { 
            color: var(--green); 
            font-weight: bold;
        }
        
        .hl-blue { 
            color: var(--blue); 
            font-weight: bold;
        }
        
        .hl-red { 
            color: var(--red); 
            font-weight: bold;
        }
        
        .hl-yellow { 
            color: var(--yellow); 
            font-weight: bold;
        }

        .info-list {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }
        
        .info-list li {
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(0, 243, 255, 0.1);
            border-left: 3px solid var(--blue);
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .info-list li::before {
            content: "‚ñ∏";
            color: var(--green);
            font-weight: bold;
            margin-right: 10px;
        }

        /* DEMO BOX */
        .demo-box {
            background: #000;
            border: 2px solid var(--green);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            overflow: visible;
            position: relative;
        }
        
        .demo-title {
            color: var(--green);
            font-family: monospace;
            font-size: 0.9rem;
            text-transform: uppercase;
            margin-bottom: 12px;
            border-bottom: 1px solid #333;
            padding-bottom: 6px;
        }

        /* SIMPLE TABLE */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: #000;
            font-size: 0.85rem;
        }
        
        th {
            background: var(--blue);
            color: #000;
            padding: 10px 8px;
            text-align: left;
            font-family: monospace;
            text-transform: uppercase;
            font-size: 0.8rem;
        }
        
        td {
            padding: 10px 8px;
            border-bottom: 1px solid #333;
            color: #ccc;
        }
        
        tr:hover td {
            background: rgba(0, 243, 255, 0.1);
        }

        /* CODE BOX */
        .code-box {
            background: #0a0a0a;
            border: 1px solid #333;
            border-left: 3px solid var(--green);
            border-radius: 4px;
            padding: 12px;
            margin: 12px 0;
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--green);
            overflow-x: auto;
            line-height: 1.6;
        }
        
        .code-comment {
            color: #666;
            font-style: italic;
        }

        /* KNOWLEDGE BOX */
        .kb {
            background: rgba(255, 221, 0, 0.1);
            border: 2px solid var(--yellow);
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
        }
        
        .kb h4 {
            color: var(--yellow);
            margin: 0 0 8px 0;
            font-size: 1rem;
        }
        
        .kb h4::before {
            content: "üí° ";
        }

        /* NEURAL DEMO */
        .neural-demo {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 20px 10px;
            flex-wrap: wrap;
            gap: 15px;
            position: relative;
            z-index: 1;
            overflow: visible;
        }
        
        .neuron-layer {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
            position: relative;
            z-index: 2;
        }
        
        .layer-label {
            color: var(--blue);
            font-size: 0.75rem;
            font-family: monospace;
            text-transform: uppercase;
            font-weight: bold;
        }
        
        .neuron {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #555, #222);
            border: 3px solid #666;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 0.85rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }
        
        .neuron::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid var(--green);
            opacity: 0;
            animation: neuron-hint 3s ease-in-out infinite;
        }
        
        @keyframes neuron-hint {
            0%, 100% { transform: scale(1); opacity: 0; }
            50% { transform: scale(1.4); opacity: 0.6; }
        }
        
        .neuron:active, .neuron:hover {
            transform: scale(1.15);
            border-color: var(--green);
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.5);
        }
        
        .neuron:hover::after {
            animation: none;
        }
        
        .neuron.active {
            background: radial-gradient(circle at 30% 30%, var(--green), #00aa22);
            border-color: var(--green);
            box-shadow: 0 0 25px var(--green);
            animation: neuron-pulse 0.6s ease-out;
        }
        
        @keyframes neuron-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); box-shadow: 0 0 35px var(--green); }
            100% { transform: scale(1); }
        }
        
        .arrow {
            font-size: 2.5rem;
            color: var(--green);
            font-weight: bold;
            text-shadow: 0 0 15px var(--green);
            user-select: none;
            animation: arrow-pulse 2s ease-in-out infinite;
        }
        
        @keyframes arrow-pulse {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }

        /* PERCEPTRON DEMO */
        .perceptron-demo {
            background: #000;
            border: 2px solid var(--blue);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .perceptron-visual {
            background: #000;
            border: 2px solid var(--green);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }
        
        .perceptron-canvas-wrapper {
            background: #0a0a0a;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            display: flex;
            justify-content: center;
        }
        
        #perceptronCanvas {
            border: 1px solid #333;
            border-radius: 6px;
            max-width: 100%;
            height: auto;
        }
        
        @media (max-width: 480px) {
            #perceptronCanvas {
                width: 100%;
            }
        }
        
        .input-slider-group {
            margin: 12px 0;
            padding: 10px;
            background: rgba(0, 243, 255, 0.05);
            border-radius: 6px;
        }
        
        .input-slider-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .result-display {
            background: rgba(0, 255, 65, 0.1);
            border: 2px solid var(--green);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            text-align: center;
        }
        
        .result-display h4 {
            color: var(--green);
            font-size: 1rem;
            margin: 0 0 10px 0;
        }
        
        .result-value {
            font-size: 2rem;
            font-family: monospace;
            color: var(--green);
            font-weight: bold;
        }

        /* ACCORDION */
        .accordion {
            background: var(--panel-bg);
            border: 1px solid #333;
            border-radius: 6px;
            margin-bottom: 8px;
            overflow: hidden;
        }
        
        .accordion-header {
            background: #222;
            padding: 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        
        .accordion-header:active {
            background: #2a2a2a;
        }
        
        .accordion-header h4 {
            margin: 0;
            color: var(--blue);
            font-size: 0.95rem;
        }
        
        .accordion-icon {
            color: var(--green);
            font-size: 1rem;
            font-weight: bold;
            transition: transform 0.3s ease;
        }
        
        .accordion.active .accordion-icon {
            transform: rotate(180deg);
        }
        
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .accordion.active .accordion-content {
            max-height: 2000px;
        }
        
        .accordion-content-inner {
            padding: 12px;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            h1 { font-size: 1.2rem; }
            .subtitle { font-size: 0.75rem; }
            .game-wrapper { height: 600px; padding: 8px; }
            .brain-hud { 
                width: 180px; 
                height: 170px;
                top: 12px;
                right: 12px;
                padding: 7px;
            }
            #netCanvas {
                width: 166px;
                height: 150px;
            }
            .brain-title { font-size: 7px; }
            .control-grid { grid-template-columns: 1fr; }
            .score-board { gap: 5px; padding: 8px; }
            .stat-box { padding: 8px 4px; }
            .value { font-size: 1.2rem; }
            .label { font-size: 0.6rem; }
            .neural-demo { flex-direction: column; gap: 10px; }
            .neuron { width: 35px; height: 35px; font-size: 0.7rem; }
            th, td { padding: 8px 5px; font-size: 0.8rem; }
        }

        @media (max-width: 480px) {
            .game-wrapper { height: 500px; padding: 5px; }
            .brain-hud { 
                width: 160px;
                height: 150px;
                padding: 6px;
                top: 10px;
                right: 10px;
            }
            #netCanvas {
                width: 148px;
                height: 132px;
            }
            .brain-title { font-size: 7px; padding-bottom: 2px; margin-bottom: 3px; }
        }

        /* LOADING */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(0, 255, 65, 0.3);
            border-radius: 50%;
            border-top-color: var(--green);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

    </style>
</head>
<body>

<div class="container">

    <!-- HEADER -->
    <header>
        <h1>ü§ñ KI LABOR - FLAPPY LERNT FLIEGEN üß†</h1>
        <span class="subtitle">Wie Computer lernen - einfach erkl√§rt f√ºr Kids!</span>
    </header>

    <!-- SCORE BOARD -->
    <div class="score-board">
        <div class="stat-box">
            <span class="label">Generation</span>
            <span id="genDisp" class="value hl">1</span>
        </div>
        <div class="stat-box">
            <span class="label">Lebend</span>
            <span id="aliveDisp" class="value">0</span>
        </div>
        <div class="stat-box">
            <span class="label">Score</span>
            <span id="scoreDisp" class="value">0</span>
        </div>
        <div class="stat-box">
            <span class="label">Rekord</span>
            <span id="highDisp" class="value hl">0</span>
        </div>
    </div>

    <!-- GAME -->
    <div class="game-wrapper" id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div class="brain-hud">
            <div class="brain-title">üß† Gehirn Live</div>
            <canvas id="netCanvas" width="194" height="172"></canvas>
        </div>
    </div>

    <!-- CONTROLS -->
    <div class="controls-panel">
        <h3>‚öôÔ∏è Einstellungen</h3>
        
        <div class="control-grid">
            <div class="control-group">
                <label>üë• Population <span id="popVal">100</span></label>
                <input type="range" id="popInput" min="10" max="500" step="10" value="100">
            </div>
            
            <div class="control-group">
                <label>üìè Rohrabstand <span id="gapVal">160</span></label>
                <input type="range" id="gapInput" min="100" max="250" step="10" value="160">
            </div>
            
            <div class="control-group">
                <label>‚¨áÔ∏è Schwerkraft <span id="gravVal">0.5</span></label>
                <input type="range" id="gravInput" min="0.1" max="1.5" step="0.1" value="0.5">
            </div>
            
            <div class="control-group">
                <label>‚ö° Speed <span id="speedVal">1x</span></label>
                <input type="range" id="speedSlider" min="1" max="50" value="1" 
                       oninput="document.getElementById('speedVal').innerText=this.value+'x'">
                <small style="color: #888; display: block; margin-top: 5px; font-size: 0.75rem;">
                    üí° Tipp: Bei Speed > 10x sind V√∂gel schwerer zu sehen
                </small>
            </div>
            
            <!-- NEW THEME TOGGLE -->
            <div class="control-group">
                <label>üåó Design</label>
                <button class="btn-theme" onclick="toggleTheme()" id="themeBtn">Hintergrund: üåë Schwarz</button>
            </div>
        </div>
        
        <div class="control-group">
            <label>üéØ Max Score (0 = kein Limit)</label>
            <input type="number" id="maxScoreInput" value="0" min="0" placeholder="0">
        </div>
        
        <div class="control-group">
            <label>üé® Vogel-Bild URL (optional)</label>
            <input type="text" id="birdImageInput" 
                   value="https://raw.githubusercontent.com/Jamancode/Python3/master/Schmierheft/Spiele/Flappybird_KI/flappyduck2.png" 
                   placeholder="https://...">
            <small style="color: #888; display: block; margin-top: 5px; font-size: 0.75rem; line-height: 1.4;">
                ‚ö° <strong style="color: var(--green);">EINMAL-FILTER!</strong> Wird beim Laden angewendet<br>
                üöÄ <strong style="color: var(--blue);">KEIN LAG!</strong> Filter nicht pro Frame, sondern einmalig!<br>
                üé® Kontrast +30%, S√§ttigung +20%, Brightness +5%
            </small>
        </div>
        
        <div class="btn-row">
            <button class="btn-start" onclick="applySettings()">‚ñ∂ START</button>
            <button class="btn-reset" onclick="resetToDefault()">‚Ü∫ RESET</button>
        </div>
    </div>

    <!-- ERKL√ÑRUNGEN -->
    
    <!-- 1. REINFORCEMENT LEARNING -->
    <div class="section-toggle">
        <div class="toggle-header" onclick="toggleSection(this)">
            <h3>üéÆ Was ist Reinforcement Learning?</h3>
            <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="toggle-content">
            <div class="toggle-content-inner">
                <div class="info-text">
                    <p><strong>Reinforcement Learning</strong> = <span class="hl-green">"Lernen durch √úben"</span></p>
                    
                    <p>Stell dir vor, du lernst Skateboard fahren! üõπ</p>
                    
                    <ul class="info-list">
                        <li>Versuch 1: Du f√§llst hin üò¢ ‚Üí Schlecht!</li>
                        <li>Versuch 10: Du f√§hrst 3 Meter! üòä ‚Üí Besser!</li>
                        <li>Versuch 100: Du machst Tricks! ü§© ‚Üí Super!</li>
                    </ul>

                    <p><span class="hl-green">Genau so lernt unser Vogel!</span> Er probiert es immer wieder und wird besser.</p>

                    <div class="demo-box">
                        <div class="demo-title">üìä Die 3 Schritte beim Lernen</div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Schritt</th>
                                    <th>Was passiert?</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>1. Ausprobieren</td>
                                    <td>Vogel fliegt und springt</td>
                                </tr>
                                <tr>
                                    <td>2. Bewerten</td>
                                    <td>√úberlebt? ‚Üí GUT! Gecrasht? ‚Üí SCHLECHT!</td>
                                </tr>
                                <tr>
                                    <td>3. Lernen</td>
                                    <td>Merke dir, was gut war!</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="kb">
                        <h4>Wo wird das noch benutzt?</h4>
                        <ul class="info-list">
                            <li>ü§ñ Roboter lernen zu laufen (wie Babys!)</li>
                            <li>üéÆ Spiele-KI (Schach, Go) - schl√§gt Weltmeister!</li>
                            <li>üöó Selbstfahrende Autos - √ºben in Simulationen!</li>
                            <li>ü¶æ Roboter-Arme greifen Gegenst√§nde</li>
                        </ul>
                    </div>
                    
                    <div class="kb">
                        <h4>Coole Facts!</h4>
                        <p style="font-size: 0.85rem; color: #ccc; line-height: 1.6;">
                            üéØ AlphaGo (Google KI) lernte Go spielen und schlug 2016 den Weltmeister!<br>
                            üéÆ OpenAI trainierte eine KI, die Dota 2 spielt - brauchte <span class="hl-yellow">10.000 Jahre Spielzeit!</span><br>
                            üêï Auch Hunde lernen mit Belohnung (Leckerlis) - genau wie RL!<br>
                            üìà Unser Vogel wird nach ~50 Generationen zum Profi!
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. NEURONALE NETZE -->
    <div class="section-toggle">
        <div class="toggle-header" onclick="toggleSection(this)">
            <h3>üß† Neuronale Netze - Das Gehirn</h3>
            <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="toggle-content">
            <div class="toggle-content-inner">
                <div class="info-text">
                    <p><strong>Jeder Vogel hat ein k√ºnstliches Gehirn!</strong></p>

                    <div class="demo-box" style="border: 3px solid var(--green); background: rgba(0, 255, 65, 0.05);">
                        <div class="demo-title" style="font-size: 1rem; color: var(--green);">‚ö° DAS GEHIRN (KLICK DIE KREISE!)</div>
                        <p style="color: #00ff41; text-align: center; margin-bottom: 5px; font-size: 0.95rem; font-weight: bold;">
                            üëÜ TIPP: Klick auf die EINGABE-Neuronen (y, Œîy, Œîx, v)
                        </p>
                        <p style="color: #ccc; text-align: center; margin-bottom: 15px; font-size: 0.85rem;">
                            Dann siehst du den <strong style="color: var(--green);">KOMPLETTEN WEG</strong> durch das Gehirn:<br>
                            Input ‚Üí Hidden ‚Üí Output ‚Üí Entscheidung! üß†‚ú®
                        </p>
                        <div class="neural-demo" style="padding: 20px 10px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                            <div class="neuron-layer">
                                <div class="layer-label" style="color: var(--blue); font-weight: bold;">EINGABE</div>
                                <div class="neuron" onclick="activateNeuron(this)" title="Position vom Vogel - Klick mich!">y</div>
                                <div class="neuron" onclick="activateNeuron(this)" title="Wie schnell f√§llt er? - Klick mich!">Œîy</div>
                                <div class="neuron" onclick="activateNeuron(this)" title="Abstand zum Rohr - Klick mich!">Œîx</div>
                                <div class="neuron" onclick="activateNeuron(this)" title="Geschwindigkeit - Klick mich!">v</div>
                            </div>
                            
                            <div class="arrow" style="color: var(--green); font-size: 2.5rem; text-shadow: 0 0 10px var(--green);">‚Üí</div>
                            
                            <div class="neuron-layer">
                                <div class="layer-label" style="color: var(--blue); font-weight: bold;">VERSTECKT</div>
                                <div class="neuron" onclick="activateNeuron(this)" title="Rechnet und denkt nach">üßÆ</div>
                                <div class="neuron" onclick="activateNeuron(this)" title="Kombiniert Infos">üîó</div>
                                <div class="neuron" onclick="activateNeuron(this)" title="Findet Muster">üéØ</div>
                                <div class="neuron" onclick="activateNeuron(this)" title="Macht Entscheidung">üí≠</div>
                            </div>
                            
                            <div class="arrow" style="color: var(--green); font-size: 2.5rem; text-shadow: 0 0 10px var(--green);">‚Üí</div>
                            
                            <div class="neuron-layer">
                                <div class="layer-label" style="color: var(--blue); font-weight: bold;">AUSGABE</div>
                                <div class="neuron" onclick="activateNeuron(this)" title="Zeigt die Entscheidung!" style="width: 50px; height: 50px; font-size: 1.3rem;">?</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 12px; background: rgba(0, 243, 255, 0.1); border-radius: 8px; border-left: 3px solid var(--blue);">
                            <p style="color: var(--blue); font-weight: bold; margin-bottom: 8px; font-size: 0.9rem;">
                                üí° So funktioniert ein echtes neuronales Netz:
                            </p>
                            <ul style="list-style: none; padding: 0; color: #ccc; font-size: 0.85rem; line-height: 1.9;">
                                <li style="margin-bottom: 8px;"><strong style="color: var(--green);">SCHRITT 1:</strong> Klick EINGABE ‚Üí üü¢ Signal fliegt zu ALLEN Hidden (parallel!)</li>
                                <li style="margin-bottom: 8px;"><strong style="color: var(--green);">SCHRITT 2:</strong> ALLE Hidden empfangen ‚Üí üí≠ aktivieren GLEICHZEITIG!</li>
                                <li style="margin-bottom: 8px;"><strong style="color: var(--green);">SCHRITT 3:</strong> ALLE Hidden senden zu Output ‚Üí üìä Output wartet!</li>
                                <li style="margin-bottom: 8px;"><strong style="color: var(--green);">SCHRITT 4:</strong> Output sammelt ALLE Signale ‚Üí üîÑ berechnet!</li>
                                <li style="margin-bottom: 8px;"><strong style="color: var(--green);">SCHRITT 5:</strong> Zeigt Aktivierung (0.73) ‚Üí ‚úÖ SPRING! oder ‚õî WARTE!</li>
                            </ul>
                            <div style="margin-top: 10px; padding: 8px; background: rgba(0,255,65,0.15); border-radius: 4px; border-left: 2px solid var(--green);">
                                <strong style="color: var(--green);">üéØ TRY IT!</strong> Klick ein EINGABE-Neuron und sieh den ganzen Weg!<br>
                                <span style="font-size: 0.75rem; opacity: 0.9;">Achte auf: Parallel-Aktivierung + Spinner + Aktivierungswert!</span>
                            </div>
                        </div>
                        
                        <div style="margin-top: 12px; padding: 12px; background: rgba(255, 215, 0, 0.1); border-radius: 8px; border-left: 3px solid var(--yellow);">
                            <p style="color: var(--yellow); font-weight: bold; margin-bottom: 8px; font-size: 0.85rem;">
                                üî¨ Wie ein echtes Gehirn arbeitet:
                            </p>
                            <p style="color: #ccc; font-size: 0.8rem; line-height: 1.6;">
                                <strong>1. Sinne (Input):</strong> Du siehst einen Ball ‚Üí Augen senden Signal<br>
                                <strong>2. Gehirn (Hidden):</strong> ALLE Neuronen verarbeiten PARALLEL: "Ball fliegt zu mir!"<br>
                                <strong>3. Sammeln (Output):</strong> Output wartet bis ALLE Infos da sind<br>
                                <strong>4. Berechnen:</strong> Kombiniert alle Inputs ‚Üí entscheidet!<br>
                                <strong>5. Entscheidung:</strong> "Fang ihn!" ‚Üí Hand bewegt sich!<br>
                                <span style="color: var(--green); margin-top: 5px; display: block;">‚ö° Dein Gehirn macht das in 0,2 Sekunden - so schnell bist du!</span>
                            </p>
                        </div>
                        
                        <div style="margin-top: 12px; padding: 10px; background: rgba(255,0,85,0.1); border-radius: 8px; border-left: 3px solid var(--red);">
                            <p style="color: #ccc; font-size: 0.75rem; line-height: 1.5;">
                                <strong style="color: var(--red);">‚ùó WICHTIG:</strong> In einem echten Netz passiert alles <strong style="color: var(--green);">GLEICHZEITIG</strong> (parallel)!<br>
                                Die Hidden-Neuronen warten nicht aufeinander - sie rechnen alle zur selben Zeit!<br>
                                Output wartet bis <strong>ALLE</strong> Signale da sind - wie ein Schiedsrichter, der auf alle Stimmen h√∂rt!
                            </p>
                        </div>
                        
                        <div class="kb" style="margin-top: 15px;">
                            <h4>Wie dein echtes Gehirn!</h4>
                            <p style="font-size: 0.85rem; color: #ccc; line-height: 1.6;">
                                üß† Dein Gehirn hat <span class="hl-green">86 Milliarden</span> Neuronen!<br>
                                ‚ö° Signale rasen mit <span class="hl-blue">400 km/h</span> durch deine Nerven!<br>
                                üåü Unser Vogel hat nur 50 Neuronen - dein Gehirn ist 1,7 MILLIARDEN mal gr√∂√üer!<br>
                                üí≠ Jedes Neuron kann mit 10.000 anderen "sprechen"!
                            </p>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>Schicht</th>
                                <th>Aufgabe</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="hl-green">Eingabe</span></td>
                                <td>Infos sammeln (Position, Geschwindigkeit)</td>
                            </tr>
                            <tr>
                                <td><span class="hl-blue">Versteckt</span></td>
                                <td>Nachdenken & Rechnen</td>
                            </tr>
                            <tr>
                                <td><span class="hl-yellow">Ausgabe</span></td>
                                <td>Entscheiden: Springen oder nicht?</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="kb">
                        <h4>Im Spiel siehst du das!</h4>
                        <p><span class="hl-blue">Blaue Linien</span> = Wichtig!<br>
                        <span class="hl-red">Rote Linien</span> = Unwichtig!<br>
                        Je dicker, desto wichtiger!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. PERZEPTRON -->
    <div class="section-toggle">
        <div class="toggle-header" onclick="toggleSection(this)">
            <h3>‚öôÔ∏è Perzeptron - Der Baustein</h3>
            <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="toggle-content">
            <div class="toggle-content-inner">
                <div class="info-text">
                    <p>Ein <span class="hl-green">Perzeptron</span> ist wie ein winziger Rechner!</p>

                    <div class="perceptron-demo">
                        <p style="text-align: center; margin-bottom: 15px;">
                            <strong>Entscheide: Rausgehen? üèÉ</strong>
                        </p>
                        
                        <div class="input-slider-group">
                            <label>‚òÄÔ∏è Sonnenschein <span id="sunVal">50</span>%</label>
                            <input type="range" id="sunInput" min="0" max="100" value="50" 
                                   oninput="updatePerceptron()">
                        </div>
                        
                        <div class="input-slider-group">
                            <label>üå°Ô∏è Warm genug <span id="tempVal">50</span>%</label>
                            <input type="range" id="tempInput" min="0" max="100" value="50" 
                                   oninput="updatePerceptron()">
                        </div>
                        
                        <div class="input-slider-group">
                            <label>üåßÔ∏è Regnet es <span id="rainVal">50</span>%</label>
                            <input type="range" id="rainInput" min="0" max="100" value="50" 
                                   oninput="updatePerceptron()">
                        </div>
                        
                        <div class="result-display">
                            <h4>ENTSCHEIDUNG:</h4>
                            <div class="result-value" id="perceptronResult">?</div>
                            <p style="color: #ccc; margin-top: 10px; font-size: 0.85rem;" id="perceptronExplain"></p>
                        </div>
                    </div>

                    <div class="perceptron-visual">
                        <div class="demo-title">‚ö° LIVE PERZEPTRON-NETZ</div>
                        <p style="color: #ccc; font-size: 0.85rem; margin-bottom: 10px;">
                            Hier siehst du, wie das Perzeptron arbeitet!
                        </p>
                        <div class="perceptron-canvas-wrapper">
                            <canvas id="perceptronCanvas" width="400" height="300"></canvas>
                        </div>
                        <p style="color: #888; font-size: 0.75rem; margin-top: 10px;">
                            üü¢ Aktive Neuronen = Stark<br>
                            üî¥ Negative Gewichte = Hemmen<br>
                            üîµ Positive Gewichte = F√∂rdern
                        </p>
                    </div>

                    <p><strong>So rechnet es:</strong></p>
                    
                    <div class="code-box">
Sonnenschein √ó 3 = Punkte<br>
Temperatur √ó 2 = Punkte<br>
Regen √ó (-5) = Punkte<br>
<br>
Alles zusammen ‚Üí Entscheidung!<br>
Viele Punkte ‚Üí <span style="color: var(--green)">JA!</span><br>
Wenig Punkte ‚Üí <span style="color: var(--red)">NEIN!</span>
                    </div>

                    <div class="kb">
                        <h4>Fun Fact!</h4>
                        <p>Das Perzeptron ist √ºber 65 Jahre alt! (1958)<br>
                        Damals war es eine riesige Maschine!<br>
                        Heute passen Millionen in dein Handy! üì±</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. EVOLUTION -->
    <div class="section-toggle">
        <div class="toggle-header" onclick="toggleSection(this)">
            <h3>üìö Evolution - Wie wird er besser?</h3>
            <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="toggle-content">
            <div class="toggle-content-inner">
                <div class="info-text">
                    <p><strong>Die Antwort:</strong> <span class="hl-green">Evolution!</span> ü¶ï‚Üíü¶ñ‚Üíüê¶</p>

                    <div class="accordion">
                        <div class="accordion-header" onclick="toggleAccordion(this)">
                            <h4>1Ô∏è‚É£ Alle V√∂gel versuchen es</h4>
                            <span class="accordion-icon">‚ñº</span>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-content-inner">
                                <p>Am Anfang starten 100 V√∂gel mit <span class="hl-blue">zuf√§lligen Gehirnen</span>.</p>
                                <p>Die meisten knallen sofort gegen das Rohr... <span class="hl-red">üí• BONK!</span></p>
                                <p>Aber ein paar kommen weiter! üéâ</p>
                                <p style="margin-top: 10px; font-size: 0.85rem; color: #888;">
                                    <strong>Wie bei Babys:</strong> Manche k√∂nnen fr√ºher laufen, andere sp√§ter!
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="accordion">
                        <div class="accordion-header" onclick="toggleAccordion(this)">
                            <h4>2Ô∏è‚É£ Der Beste wird Champion!</h4>
                            <span class="accordion-icon">‚ñº</span>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-content-inner">
                                <p>Welcher Vogel kam am weitesten?</p>
                                <p>Er bekommt die beste <span class="hl-green">"Fitness"</span> - wie eine Note! üìù</p>
                                <p style="margin-top: 10px; font-size: 0.85rem; color: #888;">
                                    <strong>In der Natur:</strong> Die st√§rksten/schnellsten Tiere √ºberleben!<br>
                                    ü¶Å L√∂we mit mehr Muskeln f√§ngt mehr Beute<br>
                                    ü¶í Giraffe mit l√§ngerem Hals kommt an h√∂here Bl√§tter
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="accordion">
                        <div class="accordion-header" onclick="toggleAccordion(this)">
                            <h4>3Ô∏è‚É£ Die Besten bekommen "Kinder"</h4>
                            <span class="accordion-icon">‚ñº</span>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-content-inner">
                                <p>Die besten V√∂gel <span class="hl-green">"vererben"</span> ihr Gehirn!</p>
                                <p>Wie bei echten Tieren: Papa ‚Üí Baby üë∂</p>
                                <p style="margin-top: 10px; font-size: 0.85rem; color: #888;">
                                    <strong>Echtes Beispiel:</strong><br>
                                    üë® Papa ist gro√ü (1,90m)<br>
                                    üë∂ Kind wird wahrscheinlich auch gro√ü!<br>
                                    üß¨ Gene werden weitergegeben!
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="accordion">
                        <div class="accordion-header" onclick="toggleAccordion(this)">
                            <h4>4Ô∏è‚É£ Mutation - Zuf√§llige √Ñnderungen!</h4>
                            <span class="accordion-icon">‚ñº</span>
                        </div>
                        <div class="accordion-content">
                            <div class="accordion-content-inner">
                                <p><span class="hl-yellow">Mutation</span> = Kleine zuf√§llige √Ñnderungen! üé≤</p>
                                <p>Das Gehirn wird kopiert, aber mit kleinen Unterschieden!</p>
                                <ul class="info-list">
                                    <li>Manche werden besser! üìà</li>
                                    <li>Manche schlechter... aber okay! üìâ</li>
                                    <li>So funktioniert Evolution! üîÑ</li>
                                </ul>
                                <p style="margin-top: 10px; font-size: 0.85rem; color: #888;">
                                    <strong>In der Natur:</strong><br>
                                    üêª‚Äç‚ùÑÔ∏è Eisb√§ren waren mal braune B√§ren!<br>
                                    Durch Mutationen wurden manche wei√üer ‚Üí besser getarnt im Schnee!<br>
                                    ü¶ã Schmetterlinge entwickelten bunte Farben zur Warnung!<br>
                                    ü¶é Cham√§leons lernten Farbe zu wechseln!
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="kb">
                        <h4>Beobachte es!</h4>
                        <p>Die <strong>Generation</strong> steigt!<br>
                        Der <strong>Rekord</strong> wird besser!<br>
                        Nach ~50 Generationen sind sie Profis! üèÜ</p>
                    </div>
                    
                    <div class="kb">
                        <h4>Mega Fun Fact!</h4>
                        <p style="font-size: 0.85rem; color: #ccc; line-height: 1.6;">
                            ü¶ñ Echte Evolution dauert <span class="hl-green">Millionen Jahre</span>!<br>
                            ‚ö° Unser Vogel lernt in <span class="hl-blue">Sekunden</span>!<br>
                            üß¨ Menschen haben sich √ºber 7 Millionen Jahre entwickelt!<br>
                            ü§ñ KI-Evolution = Turbo-Modus der Natur! üöÄ
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. TRANSFORMERS -->
    <div class="section-toggle">
        <div class="toggle-header" onclick="toggleSection(this)">
            <h3>üöÄ Transformers - Die Super-KI</h3>
            <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="toggle-content">
            <div class="toggle-content-inner">
                <div class="info-text">
                    <p>Du kennst <strong>ChatGPT</strong>? ü§ñ Das ist ein <span class="hl-blue">Transformer</span>!</p>

                    <div class="demo-box">
                        <div class="demo-title">üÜö Unser Vogel vs. ChatGPT</div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Eigenschaft</th>
                                    <th>Vogel üê¶</th>
                                    <th>ChatGPT ü§ñ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Neuronen</td>
                                    <td>~50</td>
                                    <td>175 Milliarden!</td>
                                </tr>
                                <tr>
                                    <td>Gr√∂√üe</td>
                                    <td>üêú Ameise</td>
                                    <td>üêã Blauwal</td>
                                </tr>
                                <tr>
                                    <td>Kann</td>
                                    <td>Flappy spielen</td>
                                    <td>Texte, Code, Bilder...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <p><strong>Was ist "Attention"?</strong></p>
                    <p>Transformers haben einen Trick: Sie verbinden W√∂rter die zusammengeh√∂ren!</p>
                    
                    <div class="code-box">
Satz: "Der Vogel fliegt, weil ER Hunger hat"<br>
<br>
Transformer denkt: "ER" = der "Vogel"! ‚úì<br>
Das ist Attention! üëÄ
                    </div>

                    <p><strong>Wo werden sie benutzt?</strong></p>
                    <ul class="info-list">
                        <li>üí¨ Texte: ChatGPT, Bard</li>
                        <li>üåç √úbersetzen: DeepL</li>
                        <li>üé® Bilder: DALL-E</li>
                        <li>üíª Code: Copilot</li>
                    </ul>

                    <div class="kb">
                        <h4>F√ºr unser Spiel?</h4>
                        <p>Zu kompliziert! üòÑ<br>
                        Wie mit einem Ferrari zum B√§cker! üèéÔ∏è‚Üíü•ê<br>
                        Unser einfaches Netz reicht! ‚úÖ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 6. ZUSAMMENFASSUNG -->
    <div class="section-toggle active">
        <div class="toggle-header" onclick="toggleSection(this)">
            <h3>üìä Zusammenfassung - Alles auf einen Blick!</h3>
            <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="toggle-content">
            <div class="toggle-content-inner">
                <div class="info-text">
                    <table>
                        <thead>
                            <tr>
                                <th>Begriff</th>
                                <th>Was ist das?</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="hl-green">Reinforcement Learning</span></td>
                                <td>Lernen durch Ausprobieren</td>
                            </tr>
                            <tr>
                                <td><span class="hl-blue">Neuronales Netz</span></td>
                                <td>Das "Gehirn" aus Neuronen</td>
                            </tr>
                            <tr>
                                <td><span class="hl-yellow">Perzeptron</span></td>
                                <td>Ein einzelnes Neuron</td>
                            </tr>
                            <tr>
                                <td><span class="hl-green">Mutation</span></td>
                                <td>Zuf√§llige √Ñnderungen</td>
                            </tr>
                            <tr>
                                <td><span class="hl-blue">Fitness</span></td>
                                <td>Wie gut ist ein Vogel?</td>
                            </tr>
                        </tbody>
                    </table>

                    <div style="margin-top: 20px; padding: 20px; background: rgba(0,255,65,0.1); border-radius: 8px; border: 2px solid var(--green);">
                        <h4 style="color: var(--green); text-align: center; margin-top: 0;">üéØ Was du gelernt hast:</h4>
                        <ul class="info-list">
                            <li>Computer k√∂nnen lernen wie du!</li>
                            <li>Ein Netz = k√ºnstliches Gehirn</li>
                            <li>Durch √úben wird's besser!</li>
                            <li>Es gibt einfache und komplexe KI</li>
                            <li>Du verstehst jetzt KI! üåü</li>
                        </ul>
                    </div>

                    <div class="kb">
                        <h4>Experimentiere!</h4>
                        <p><strong>Probiere aus:</strong></p>
                        <ul class="info-list">
                            <li>‚¨ÜÔ∏è Mehr Schwerkraft - schwerer?</li>
                            <li>üìè Rohrabstand √§ndern</li>
                            <li>üë• Mehr V√∂gel - schneller?</li>
                            <li>‚ö° Speed hochdrehen!</li>
                            <li>üé® Eigenes Vogel-Bild!</li>
                        </ul>
                        <p style="text-align: center; font-size: 1.1rem; margin-top: 15px;">
                            <strong>Nach ~50 Generationen sind sie Profis! üèÜ</strong>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
// ====================================
// SPIEL-CODE
// ====================================

const DEFAULT_POP = 100, DEFAULT_GAP = 160, DEFAULT_GRAV = 0.5;
const DEFAULT_BIRD_URL = "https://raw.githubusercontent.com/Jamancode/Python3/master/Schmierheft/Spiele/Flappybird_KI/flappyduck2.png";

let POPULATION = DEFAULT_POP, PIPE_GAP = DEFAULT_GAP, GRAVITY = DEFAULT_GRAV;
let MAX_SCORE_LIMIT = 0;
const JUMP_STRENGTH = -8, PIPE_SPEED = 3, PIPE_SPAWN_X = 250;

let canvas = document.getElementById('gameCanvas');
let ctx = canvas.getContext('2d');
let netCanvas = document.getElementById('netCanvas');
let netCtx = netCanvas.getContext('2d');

let cw, ch;
function resizeCanvas() {
    let rect = document.getElementById('gameContainer').getBoundingClientRect();
    cw = rect.width; 
    ch = rect.height;
    canvas.width = cw; 
    canvas.height = ch;
}
window.addEventListener('resize', resizeCanvas);

let birds = [], savedBirds = [], pipes = [];
let generation = 1, currentScore = 0, highScore = 0, bestBird = null;

// Vogel-Bild
let birdImg = new Image();
birdImg.crossOrigin = "anonymous";
birdImg.src = DEFAULT_BIRD_URL;

birdImg.onerror = function() {
    console.log("Fallback Vogel-Bild");
    const svg = `<svg width="34" height="24" xmlns="http://www.w3.org/2000/svg">
        <ellipse cx="17" cy="12" rx="16" ry="11" fill="#ffd700"/>
        <circle cx="12" cy="8" r="2" fill="#000"/>
        <path d="M 25 12 L 32 10 L 32 14 Z" fill="#ff8c00"/>
    </svg>`;
    birdImg.src = 'data:image/svg+xml;base64,' + btoa(svg);
};

// Neuronales Netz
class NeuralNetwork {
    constructor(copy) {
        this.inputNodes = 4, this.hiddenNodes = 4, this.outputNodes = 1;
        if(copy) {
            this.wIH = copy.wIH.map(r => r.slice());
            this.wHO = copy.wHO.map(r => r.slice());
        } else {
            this.wIH = Array.from({length:4}, ()=>Array.from({length:4}, ()=>Math.random()*2-1));
            this.wHO = Array.from({length:4}, ()=>Array.from({length:1}, ()=>Math.random()*2-1));
        }
        this.visInput = [0,0,0,0]; 
        this.visHidden = [0,0,0,0]; 
        this.visOutput = [0];
    }
    
    feedForward(inputs) {
        this.visInput = inputs.slice();
        let hidden = [];
        for(let i=0; i<4; i++) {
            let sum = 0; 
            for(let j=0; j<4; j++) sum += inputs[j] * this.wIH[j][i];
            hidden[i] = 1/(1+Math.exp(-sum));
        }
        this.visHidden = hidden.slice();
        let sum = 0; 
        for(let i=0; i<4; i++) sum += hidden[i] * this.wHO[i][0];
        let output = [1/(1+Math.exp(-sum))];
        this.visOutput = output.slice();
        return output;
    }
    
    mutate() {
        const mutationRate = 0.1, mutationAmount = 0.5;
        for(let i=0; i<4; i++) 
            for(let j=0; j<4; j++) 
                if(Math.random() < mutationRate) 
                    this.wIH[i][j] += (Math.random()*2-1)*mutationAmount;
        for(let i=0; i<4; i++) 
            if(Math.random() < mutationRate) 
                this.wHO[i][0] += (Math.random()*2-1)*mutationAmount;
    }
}

// Vogel
class Bird {
    constructor(brain) {
        this.brain = brain ? new NeuralNetwork(brain) : new NeuralNetwork();
        this.x = 150; 
        this.y = ch/2; 
        this.vy = 0; 
        this.alive = true; 
        this.fitness = 0;
        
        // Calculate proper bird dimensions based on image aspect ratio
        this.calculateDimensions();
    }
    
    calculateDimensions() {
        // Ziel-H√∂he f√ºr den Vogel (sichtbar aber nicht zu gro√ü)
        this.targetHeight = 45;
        
        if(birdImg.complete && birdImg.naturalWidth > 0) {
            // Berechne Breite basierend auf ECHTEM Aspect Ratio!
            let aspectRatio = birdImg.naturalWidth / birdImg.naturalHeight;
            this.birdWidth = this.targetHeight * aspectRatio;
            this.birdHeight = this.targetHeight;
        } else {
            // Fallback f√ºr wei√üen Kreis
            this.birdWidth = 24;
            this.birdHeight = 24;
        }
    }
    
    jump() { this.vy = JUMP_STRENGTH; }
    
    think(pipes) {
        let closest = null, minDist = Infinity;
        for(let p of pipes) {
            if(p.x + p.w > this.x && p.x < minDist) { 
                closest = p; 
                minDist = p.x; 
            }
        }
        if(!closest) return;
        
        let inputs = [
            this.y / ch,
            this.vy / 20,
            (closest.x - this.x) / cw,
            ((closest.top + PIPE_GAP/2) - this.y) / ch
        ];
        let out = this.brain.feedForward(inputs);
        if(out[0] > 0.5) this.jump();
    }
    
    update() {
        this.vy += GRAVITY; 
        this.y += this.vy;
        
        // Update dimensions if image just loaded
        if(birdImg.complete && birdImg.naturalWidth > 0 && !this.dimensionsSet) {
            this.calculateDimensions();
            this.dimensionsSet = true;
        }
        
        // Hitbox based on actual bird size
        if(this.y < 0 || this.y + this.birdHeight > ch) this.alive = false;
        if(this.alive) this.fitness++;
    }
    
    draw(isBest) {
        ctx.globalAlpha = 1.0;
        ctx.imageSmoothingEnabled = false;
        
        if(birdImg.complete && birdImg.naturalWidth > 0) {
            // Gr√ºner Kreis
            if(isBest) {
                let centerX = this.x + this.birdWidth / 2;
                let centerY = this.y + this.birdHeight / 2;
                let radius = Math.max(this.birdWidth, this.birdHeight) / 2 + 8;
                
                ctx.save();
                ctx.strokeStyle = "#00ff41";
                ctx.lineWidth = 2.5;
                ctx.shadowColor = "#00ff41";
                ctx.shadowBlur = 12;
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, Math.PI*2);
                ctx.stroke();
                ctx.restore();
            }
            
            // Zeichne das VORHER gefilterte Bild - KEIN Filter mehr hier!
            ctx.drawImage(birdImg, this.x, this.y, this.birdWidth, this.birdHeight);
            
        } else {
            // Fallback Circle
            let centerX = this.x + this.birdWidth/2;
            let centerY = this.y + this.birdHeight/2;
            
            ctx.fillStyle = isBest ? '#ffd700' : '#fff';
            ctx.beginPath(); 
            ctx.arc(centerX, centerY, 12, 0, Math.PI*2); 
            ctx.fill();
            
            if(isBest) {
                ctx.strokeStyle = "#00ff41";
                ctx.lineWidth = 3;
                ctx.shadowColor = "#00ff41";
                ctx.shadowBlur = 15;
                ctx.beginPath(); 
                ctx.arc(centerX, centerY, 18, 0, Math.PI*2); 
                ctx.stroke();
                ctx.shadowBlur = 0;
            }
        }
        
        ctx.globalAlpha = 1.0;
    }
}

// Rohr
class Pipe {
    constructor() {
        this.x = cw;
        this.w = 60;
        let minPipe = 50, maxPos = ch - minPipe - PIPE_GAP;
        this.top = Math.floor(Math.random() * (maxPos - minPipe + 1)) + minPipe;
    }
    
    update() { this.x -= PIPE_SPEED; }
    
    draw() {
        ctx.fillStyle = '#2ecc71'; 
        ctx.strokeStyle = '#27ae60'; 
        ctx.lineWidth = 3;
        ctx.fillRect(this.x, 0, this.w, this.top); 
        ctx.strokeRect(this.x, 0, this.w, this.top);
        let botY = this.top + PIPE_GAP;
        ctx.fillRect(this.x, botY, this.w, ch - botY); 
        ctx.strokeRect(this.x, botY, this.w, ch - botY);
    }
    
    hits(bird) {
        // Hitbox basiert auf den ECHTEN Vogel-Dimensionen!
        // Nutze die berechneten Dimensionen mit etwas Toleranz f√ºr Fairness
        let hitboxWidth = bird.birdWidth * 0.85;  // 85% der echten Breite
        let hitboxHeight = bird.birdHeight * 0.85; // 85% der echten H√∂he
        
        // Zentriere Hitbox auf dem Vogel
        let hitboxX = bird.x + (bird.birdWidth - hitboxWidth) / 2;
        let hitboxY = bird.y + (bird.birdHeight - hitboxHeight) / 2;
        
        // Check vertical collision (oben oder unten vom Gap)
        if(hitboxY < this.top || hitboxY + hitboxHeight > this.top + PIPE_GAP) {
            // Check horizontal overlap
            if(hitboxX + hitboxWidth > this.x && hitboxX < this.x + this.w) {
                return true;
            }
        }
        return false;
    }
}

function initGame() {
    resizeCanvas();
    birds = []; 
    savedBirds = []; 
    pipes = []; 
    currentScore = 0;
    for(let i=0; i<POPULATION; i++) birds.push(new Bird());
    pipes.push(new Pipe());
}

function nextGeneration() {
    generation++; 
    currentScore = 0; 
    pipes = [new Pipe()];
    savedBirds.sort((a,b) => b.fitness - a.fitness);
    if(savedBirds.length > 0 && savedBirds[0].fitness > highScore) 
        highScore = savedBirds[0].fitness;
    
    let newBirds = [];
    if(savedBirds.length > 0) {
        let champ = new Bird(savedBirds[0].brain); 
        champ.fitness = 0; 
        newBirds.push(champ);
    }
    
    let parentCount = Math.max(1, Math.ceil(savedBirds.length * 0.2));
    while(newBirds.length < POPULATION) {
        let parent = savedBirds[Math.floor(Math.random() * parentCount)];
        let child = new Bird(parent.brain); 
        child.brain.mutate(); 
        newBirds.push(child);
    }
    birds = newBirds; 
    savedBirds = [];
}

function drawNetwork(brain) {
    netCtx.clearRect(0, 0, netCanvas.width, netCanvas.height);
    if(!brain) return;
    
    // Perfekt angepasst f√ºr 194x172 canvas - ALLES passt rein!
    const layerX = [35, 97, 159]; 
    const nodeRadius = 10;
    
    // Create neuron positions - kompakt aber gut lesbar
    const inPos = []; 
    for(let i=0; i<4; i++) inPos.push({x: layerX[0], y: 33 + i * 33});
    const hidPos = []; 
    for(let i=0; i<4; i++) hidPos.push({x: layerX[1], y: 33 + i * 33});
    const outPos = [{x: layerX[2], y: 82.5}];

    // Draw connections - sehr sichtbar!
    const drawConn = (p1, p2, w) => {
        let strength = Math.abs(w);
        let color = w > 0 ? "0, 243, 255" : "255, 0, 85"; 
        
        let alpha = Math.min(1, strength * 1.2); 
        if(alpha < 0.35) alpha = 0.35;
        
        netCtx.strokeStyle = `rgba(${color}, ${alpha})`;
        netCtx.lineWidth = Math.max(2, strength * 4);
        
        netCtx.beginPath(); 
        netCtx.moveTo(p1.x, p1.y); 
        netCtx.lineTo(p2.x, p2.y); 
        netCtx.stroke();
    };

    // Draw all connections first
    for(let i=0; i<4; i++) 
        for(let h=0; h<4; h++) 
            drawConn(inPos[i], hidPos[h], brain.wIH[i][h]);
    for(let h=0; h<4; h++) 
        drawConn(hidPos[h], outPos[0], brain.wHO[h][0]);

    // Draw neurons mit 3 Aktivierungs-Stufen
    const drawNodes = (pos, vals) => {
        for(let i=0; i<pos.length; i++) {
            let val = vals[i] || 0; 
            
            netCtx.beginPath(); 
            netCtx.arc(pos[i].x, pos[i].y, nodeRadius, 0, Math.PI*2);
            
            // 3-Stufen Farbsystem
            let fillColor;
            if(val < 0.3) {
                let brightness = Math.floor(val * 100) + 60;
                fillColor = `rgb(${brightness}, ${brightness}, ${brightness})`;
            } else if(val < 0.6) {
                let brightness = Math.floor(val * 150) + 80;
                fillColor = `rgb(${brightness}, ${brightness}, ${brightness})`;
            } else {
                let greenIntensity = Math.floor((val - 0.6) * 637.5);
                let base = 150;
                fillColor = `rgb(${base}, ${base + greenIntensity}, ${base})`;
            }
            
            netCtx.fillStyle = fillColor;
            netCtx.fill();
            
            // Border
            if(val > 0.6) {
                netCtx.strokeStyle = "#00ff41"; 
                netCtx.lineWidth = 3;
                netCtx.shadowColor = "#00ff41";
                netCtx.shadowBlur = 15;
            } else if(val > 0.3) {
                netCtx.strokeStyle = "#888"; 
                netCtx.lineWidth = 2;
                netCtx.shadowBlur = 0;
            } else {
                netCtx.strokeStyle = "#555"; 
                netCtx.lineWidth = 2;
                netCtx.shadowBlur = 0;
            }
            netCtx.stroke();
            netCtx.shadowBlur = 0;
        }
    };

    // Draw all neurons
    drawNodes(inPos, brain.visInput); 
    drawNodes(hidPos, brain.visHidden); 
    drawNodes(outPos, brain.visOutput);

    // Layer labels - kompakt
    netCtx.fillStyle = "#00f3ff"; 
    netCtx.font = "bold 9px monospace";
    netCtx.textAlign = "center";
    netCtx.fillText("IN", layerX[0], 18); 
    netCtx.fillText("HID", layerX[1], 18); 
    netCtx.fillText("OUT", layerX[2], 18);
    
    // JUMP! indicator - PASST JETZT REIN!
    if(brain.visOutput[0] > 0.5) {
        netCtx.fillStyle = "#00ff41"; 
        netCtx.font = "bold 11px monospace"; 
        netCtx.shadowColor = "#00ff41";
        netCtx.shadowBlur = 10;
        netCtx.fillText("JUMP!", layerX[2], 160);
        netCtx.shadowBlur = 0;
    }
}

let gameRunning = false;
let animationId = null; // FIX: Variable f√ºr die Animation-ID

function loop() {
    if(!gameRunning) return;
    
    let cycles = parseInt(document.getElementById('speedSlider').value);
    
    for(let c=0; c<cycles; c++) {
        if(pipes.length === 0 || cw - pipes[pipes.length-1].x > PIPE_SPAWN_X) 
            pipes.push(new Pipe());
        
        for(let i=pipes.length-1; i>=0; i--) {
            pipes[i].update(); 
            if(pipes[i].x < -100) pipes.splice(i, 1);
        }
        
        let aliveCount = 0, tempBest = null, tempMaxFit = -1;
        for(let i=birds.length-1; i>=0; i--) {
            let b = birds[i];
            if(b.alive) {
                b.think(pipes); 
                b.update();
                let hit = false;
                if(!b.alive) hit = true; 
                for(let p of pipes) 
                    if(p.hits(b)) { 
                        hit = true; 
                        break; 
                    }
                if(hit) { 
                    b.alive = false; 
                    savedBirds.push(b); 
                } else {
                    aliveCount++;
                    if(b.fitness > tempMaxFit) { 
                        tempMaxFit = b.fitness; 
                        tempBest = b; 
                    }
                }
            }
        }
        
        if(tempBest) bestBird = tempBest;
        
        if(MAX_SCORE_LIMIT > 0 && Math.floor(currentScore/10) >= MAX_SCORE_LIMIT) {
             birds.forEach(b => { if(b.alive) savedBirds.push(b); }); 
             aliveCount = 0;
        }
        
        if(aliveCount === 0) { 
            nextGeneration(); 
            break; 
        }
        currentScore++;
    }
    
    ctx.clearRect(0, 0, cw, ch);
    for(let p of pipes) p.draw();
    for(let b of birds) if(b.alive) b.draw(b === bestBird);
    
    document.getElementById('genDisp').innerText = generation;
    document.getElementById('aliveDisp').innerText = birds.filter(b=>b.alive).length;
    let sc = Math.floor(currentScore / 10);
    document.getElementById('scoreDisp').innerText = sc;
    document.getElementById('highDisp').innerText = Math.max(sc, Math.floor(highScore/10));
    
    if(bestBird && bestBird.alive) drawNetwork(bestBird.brain);
    
    if(gameRunning) {
        // FIX: ID speichern
        animationId = requestAnimationFrame(loop);
    }
}

document.getElementById('popInput').addEventListener('input', (e) => 
    document.getElementById('popVal').innerText = e.target.value);
document.getElementById('gapInput').addEventListener('input', (e) => 
    document.getElementById('gapVal').innerText = e.target.value);
document.getElementById('gravInput').addEventListener('input', (e) => 
    document.getElementById('gravVal').innerText = e.target.value);

function applySettings() {
    // FIX 1: Alten Loop hart stoppen, bevor irgendwas anderes passiert
    gameRunning = false;
    if(animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
    }
    
    POPULATION = parseInt(document.getElementById('popInput').value);
    PIPE_GAP = parseInt(document.getElementById('gapInput').value);
    GRAVITY = parseFloat(document.getElementById('gravInput').value);
    MAX_SCORE_LIMIT = parseInt(document.getElementById('maxScoreInput').value) || 0;
    
    let newBirdUrl = document.getElementById('birdImageInput').value.trim();
    if(newBirdUrl && newBirdUrl !== birdImg.src) {
        let tempImg = new Image();
        tempImg.crossOrigin = "anonymous";
        
        tempImg.onload = function() {
            // FIX 2: WICHTIG! Globales onload deaktivieren, damit nicht DOPPELT gestartet wird
            birdImg.onload = null;
            
            // Erstelle Canvas EINMAL
            let canvas = document.createElement('canvas');
            canvas.width = tempImg.naturalWidth;
            canvas.height = tempImg.naturalHeight;
            let ctx = canvas.getContext('2d', {alpha: true, willReadFrequently: false});
            
            // Wende CSS-Filter EINMAL beim Laden an!
            ctx.imageSmoothingEnabled = false;
            ctx.filter = 'contrast(1.3) saturate(1.2) brightness(1.05)';
            ctx.drawImage(tempImg, 0, 0);
            
            // Speichere das gefilterte Bild als Data URL
            birdImg.src = canvas.toDataURL('image/png', 1.0);
            
            generation = 1; 
            highScore = 0;
            initGame();
            
            // WICHTIG: Warte bis Browser alles verarbeitet hat!
            setTimeout(() => {
                // JETZT Speed auf 1x setzen!
                document.getElementById('speedSlider').value = 1;
                document.getElementById('speedVal').innerText = "1x";
                
                // STARTE neuen Game Loop!
                gameRunning = true;
                loop();
            }, 10);
        };
        
        tempImg.onerror = function() {
            birdImg.onload = null; // Auch hier sicherheitshalber
            birdImg.src = DEFAULT_BIRD_URL;
            generation = 1; 
            highScore = 0;
            initGame();
            
            setTimeout(() => {
                document.getElementById('speedSlider').value = 1;
                document.getElementById('speedVal').innerText = "1x";
                gameRunning = true;
                loop();
            }, 10);
        };
        
        tempImg.src = newBirdUrl;
        
    } else {
        generation = 1; 
        highScore = 0; 
        initGame();
        
        setTimeout(() => {
            document.getElementById('speedSlider').value = 1;
            document.getElementById('speedVal').innerText = "1x";
            gameRunning = true;
            loop();
        }, 10);
    }
}

function resetToDefault() {
    document.getElementById('popInput').value = DEFAULT_POP; 
    document.getElementById('popVal').innerText = DEFAULT_POP;
    document.getElementById('gapInput').value = DEFAULT_GAP; 
    document.getElementById('gapVal').innerText = DEFAULT_GAP;
    document.getElementById('gravInput').value = DEFAULT_GRAV; 
    document.getElementById('gravVal').innerText = DEFAULT_GRAV;
    document.getElementById('speedSlider').value = 1; 
    document.getElementById('maxScoreInput').value = 0;
    document.getElementById('speedVal').innerText = "1x";
    document.getElementById('birdImageInput').value = DEFAULT_BIRD_URL;
    applySettings();
}

// ====================================
// THEME TOGGLE
// ====================================
let isDarkTheme = true;
function toggleTheme() {
    isDarkTheme = !isDarkTheme;
    const wrapper = document.getElementById('gameContainer');
    const btn = document.getElementById('themeBtn');
    
    if(isDarkTheme) {
        wrapper.style.background = '#000';
        wrapper.style.borderColor = '#333';
        btn.innerText = "Hintergrund: üåë Schwarz";
        btn.style.background = "#444";
        btn.style.color = "#fff";
    } else {
        wrapper.style.background = '#ffffff';
        wrapper.style.borderColor = '#ccc';
        btn.innerText = "Hintergrund: ‚òÄÔ∏è Wei√ü";
        btn.style.background = "#f0f0f0";
        btn.style.color = "#000";
    }
}


// ====================================
// INTERAKTIVE ELEMENTE
// ====================================

function activateNeuron(element) {
    // Add active class for animation
    element.classList.add('active');
    
    // Find which layer this neuron is in
    const neuronLayer = element.closest('.neuron-layer');
    const allLayers = Array.from(document.querySelectorAll('.neuron-layer'));
    const currentLayerIndex = allLayers.indexOf(neuronLayer);
    
    // Get layer type from label
    const layerLabel = neuronLayer.querySelector('.layer-label')?.textContent;
    
    // Create ripple effect immediately
    createRipple(element);
    
    // Handle different layer types
    if(layerLabel === 'EINGABE') {
        // INPUT LAYER: Start the cascade - Input ‚Üí Hidden ‚Üí Output
        const hiddenLayer = allLayers[1];
        const hiddenNeurons = Array.from(hiddenLayer.querySelectorAll('.neuron'));
        const outputLayer = allLayers[2];
        
        // Phase 1: Input ‚Üí Hidden (gestaffelt f√ºr Visualisierung)
        let signalsToHidden = [];
        hiddenNeurons.forEach((targetNeuron, index) => {
            let promise = new Promise(resolve => {
                setTimeout(() => {
                    createSignalParticle(element, targetNeuron, resolve);
                }, index * 100);
            });
            signalsToHidden.push(promise);
        });
        
        // Warte bis ALLE Signale bei Hidden angekommen sind
        Promise.all(signalsToHidden).then(() => {
            // Phase 2: Hidden verarbeitet PARALLEL!
            setTimeout(() => {
                processHiddenLayer(hiddenNeurons, outputLayer);
            }, 100);
        });
        
    } else if(layerLabel === 'VERSTECKT') {
        // HIDDEN LAYER clicked directly: Send to output
        const outputLayer = allLayers[2];
        const outputNeuron = outputLayer.querySelector('.neuron');
        
        createSignalParticle(element, outputNeuron, () => {
            setTimeout(() => {
                showOutputProcessing(outputNeuron);
            }, 100);
        });
        
    } else if(layerLabel === 'AUSGABE') {
        // OUTPUT LAYER: Show decision directly
        showOutputProcessing(element);
    }
    
    // Remove active class
    setTimeout(() => element.classList.remove('active'), 1000);
}

function processHiddenLayer(hiddenNeurons, outputLayer) {
    const outputNeuron = outputLayer.querySelector('.neuron');
    
    // WICHTIG: Aktiviere ALLE Hidden-Neuronen GLEICHZEITIG (parallel!)
    hiddenNeurons.forEach(neuron => {
        neuron.classList.add('active');
        createRipple(neuron);
    });
    
    // ALLE Hidden-Neuronen senden GLEICHZEITIG zu Output (leicht gestaffelt f√ºr Sichtbarkeit)
    let signalsToOutput = [];
    hiddenNeurons.forEach((neuron, index) => {
        let promise = new Promise(resolve => {
            setTimeout(() => {
                createSignalParticle(neuron, outputNeuron, resolve);
            }, index * 80); // Schneller gestaffelt
        });
        signalsToOutput.push(promise);
    });
    
    // Deaktiviere Hidden nach dem Senden
    setTimeout(() => {
        hiddenNeurons.forEach(neuron => {
            neuron.classList.remove('active');
        });
    }, 600);
    
    // Warte bis ALLE Signale am Output angekommen sind!
    Promise.all(signalsToOutput).then(() => {
        // JETZT verarbeitet Output die Informationen!
        setTimeout(() => {
            showOutputProcessing(outputNeuron);
        }, 100);
    });
}

function showOutputProcessing(outputNeuron) {
    // Phase 1: Output sammelt Informationen
    outputNeuron.classList.add('active');
    createRipple(outputNeuron);
    
    // Zeige "Berechnung" visuell
    const processingIndicator = document.createElement('div');
    processingIndicator.style.cssText = `
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 70px;
        height: 70px;
        border: 4px solid var(--blue);
        border-top-color: var(--green);
        border-radius: 50%;
        animation: output-spin 0.6s linear;
        pointer-events: none;
        z-index: 10001;
    `;
    
    outputNeuron.style.position = 'relative';
    outputNeuron.appendChild(processingIndicator);
    
    // Add spin animation
    if(!document.getElementById('output-spin-animation')) {
        const style = document.createElement('style');
        style.id = 'output-spin-animation';
        style.textContent = `
            @keyframes output-spin {
                0% { transform: translate(-50%, -50%) rotate(0deg) scale(0.5); opacity: 0; }
                50% { opacity: 1; }
                100% { transform: translate(-50%, -50%) rotate(360deg) scale(1); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
    
    // Remove processing indicator
    setTimeout(() => {
        if(processingIndicator.parentNode) {
            processingIndicator.remove();
        }
    }, 600);
    
    // Phase 2: Nach der "Berechnung" zeige Entscheidung!
    setTimeout(() => {
        showDecision(outputNeuron);
    }, 650);
}

function showDecision(outputNeuron) {
    // Simuliere neuronale Aktivierung: Random, aber gewichtet
    // (In echtem Netz w√§ren das die gewichteten Summen)
    const activation = Math.random();
    const decision = activation > 0.5;
    
    // Zeige Aktivierungswert kurz
    const activationDisplay = document.createElement('div');
    activationDisplay.style.cssText = `
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-weight: bold;
        font-size: 1.1rem;
        text-shadow: 0 0 10px ${decision ? '#00ff41' : '#ff4444'};
        z-index: 10002;
        pointer-events: none;
        animation: activation-flash 0.3s ease-out;
    `;
    activationDisplay.textContent = activation.toFixed(2);
    
    outputNeuron.appendChild(activationDisplay);
    
    // Add flash animation
    if(!document.getElementById('activation-flash-animation')) {
        const style = document.createElement('style');
        style.id = 'activation-flash-animation';
        style.textContent = `
            @keyframes activation-flash {
                0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
                50% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; }
                100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    }
    
    // Remove activation value
    setTimeout(() => {
        if(activationDisplay.parentNode) {
            activationDisplay.remove();
        }
    }, 300);
    
    // Zeige finale Entscheidung
    setTimeout(() => {
        const decisionBox = document.createElement('div');
        decisionBox.style.cssText = `
            position: absolute;
            top: -80px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: ${decision ? 'linear-gradient(135deg, #00ff41, #00aa22)' : 'linear-gradient(135deg, #ff4444, #aa0000)'};
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            border-radius: 10px;
            box-shadow: 0 0 25px ${decision ? '#00ff41' : '#ff4444'};
            z-index: 10003;
            animation: decision-appear 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            pointer-events: none;
            white-space: nowrap;
        `;
        
        decisionBox.innerHTML = `
            <div style="font-size: 1.4rem; margin-bottom: 3px;">${decision ? '‚úÖ' : '‚õî'}</div>
            <div>${decision ? 'SPRING!' : 'WARTE!'}</div>
            <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 3px;">Aktivierung: ${activation.toFixed(2)} ${decision ? '> 0.5' : '‚â§ 0.5'}</div>
        `;
        
        const layerElement = outputNeuron.closest('.neuron-layer');
        layerElement.style.position = 'relative';
        layerElement.appendChild(decisionBox);
        
        // Add animation if not exists
        if(!document.getElementById('decision-animation')) {
            const style = document.createElement('style');
            style.id = 'decision-animation';
            style.textContent = `
                @keyframes decision-appear {
                    0% { transform: translateX(-50%) scale(0) rotate(-10deg); opacity: 0; }
                    50% { transform: translateX(-50%) scale(1.15) rotate(5deg); }
                    100% { transform: translateX(-50%) scale(1) rotate(0deg); opacity: 1; }
                }
                @keyframes decision-fade {
                    0% { opacity: 1; transform: translateX(-50%) translateY(0); }
                    100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                }
            `;
            document.head.appendChild(style);
        }
        
        // Fade out decision
        setTimeout(() => {
            decisionBox.style.animation = 'decision-fade 0.5s ease-out forwards';
        }, 2000);
        
        // Remove decision box
        setTimeout(() => {
            if(decisionBox.parentNode) {
                decisionBox.remove();
            }
            outputNeuron.classList.remove('active');
        }, 2500);
    }, 350);
}

function createRipple(element) {
    const ripple = document.createElement('div');
    ripple.style.cssText = `
        position: absolute;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 3px solid var(--green);
        pointer-events: none;
        animation: ripple-effect 0.8s ease-out;
        top: 0;
        left: 0;
    `;
    
    element.style.position = 'relative';
    element.appendChild(ripple);
    
    // Add CSS animations if not exists
    if(!document.getElementById('signal-animations')) {
        const style = document.createElement('style');
        style.id = 'signal-animations';
        style.textContent = `
            @keyframes ripple-effect {
                0% { transform: scale(1); opacity: 1; }
                100% { transform: scale(2.8); opacity: 0; }
            }
            .signal-particle {
                position: absolute;
                width: 12px;
                height: 12px;
                background: radial-gradient(circle, #00ff41, #00aa22);
                border-radius: 50%;
                box-shadow: 0 0 15px #00ff41, 0 0 25px #00ff41;
                pointer-events: none;
                z-index: 9999;
                animation: signal-pulse 0.4s ease-in-out infinite;
            }
            @keyframes signal-pulse {
                0%, 100% { transform: scale(1); opacity: 1; }
                50% { transform: scale(1.4); opacity: 0.8; }
            }
            .signal-trail {
                position: absolute;
                height: 3px;
                background: linear-gradient(90deg, transparent, #00ff41, transparent);
                pointer-events: none;
                z-index: 9998;
                opacity: 0.7;
            }
        `;
        document.head.appendChild(style);
    }
    
    // Remove ripple after animation
    setTimeout(() => {
        if(ripple.parentNode) ripple.remove();
    }, 800);
}

function createSignalParticle(fromElement, toElement, onComplete) {
    // Get positions
    const fromRect = fromElement.getBoundingClientRect();
    const toRect = toElement.getBoundingClientRect();
    
    // Create container for this specific signal
    const container = document.querySelector('.neural-demo');
    if(!container) {
        if(onComplete) onComplete();
        return;
    }
    
    container.style.position = 'relative';
    const containerRect = container.getBoundingClientRect();
    
    // Calculate positions relative to container
    const startX = fromRect.left - containerRect.left + fromRect.width / 2;
    const startY = fromRect.top - containerRect.top + fromRect.height / 2;
    const endX = toRect.left - containerRect.left + toRect.width / 2;
    const endY = toRect.top - containerRect.top + toRect.height / 2;
    
    // Create signal particle
    const particle = document.createElement('div');
    particle.className = 'signal-particle';
    particle.style.left = startX - 6 + 'px';
    particle.style.top = startY - 6 + 'px';
    container.appendChild(particle);
    
    // Create trail effect
    const trail = document.createElement('div');
    trail.className = 'signal-trail';
    const distance = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
    const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;
    trail.style.width = '0px';
    trail.style.left = startX + 'px';
    trail.style.top = startY + 'px';
    trail.style.transformOrigin = '0 50%';
    trail.style.transform = `rotate(${angle}deg)`;
    container.appendChild(trail);
    
    // Animate trail
    setTimeout(() => {
        trail.style.transition = 'width 0.5s ease-out';
        trail.style.width = distance + 'px';
    }, 10);
    
    // Animate particle
    setTimeout(() => {
        particle.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
        particle.style.left = endX - 6 + 'px';
        particle.style.top = endY - 6 + 'px';
    }, 50);
    
    // Flash target neuron when signal arrives
    setTimeout(() => {
        toElement.classList.add('active');
        createRipple(toElement);
        setTimeout(() => toElement.classList.remove('active'), 300);
        
        // Call completion callback
        if(onComplete) onComplete();
    }, 500);
    
    // Cleanup
    setTimeout(() => {
        particle.remove();
        trail.remove();
    }, 600);
}


// Perzeptron Canvas Setup
let perceptronCanvas = document.getElementById('perceptronCanvas');
let perceptronCtx = perceptronCanvas ? perceptronCanvas.getContext('2d') : null;

// Scale canvas for mobile
function scalePerceptronCanvas() {
    if(!perceptronCanvas) return;
    
    const container = perceptronCanvas.parentElement;
    const containerWidth = container.clientWidth;
    
    if(containerWidth < 400) {
        const scale = containerWidth / 400;
        perceptronCanvas.style.width = containerWidth + 'px';
        perceptronCanvas.style.height = (300 * scale) + 'px';
    } else {
        perceptronCanvas.style.width = '400px';
        perceptronCanvas.style.height = '300px';
    }
}

// Call on load and resize
window.addEventListener('resize', scalePerceptronCanvas);
if(perceptronCanvas) scalePerceptronCanvas();

function drawPerceptronNetwork(sunVal, tempVal, rainVal, score, decision) {
    if(!perceptronCtx) return;
    
    const canvas = perceptronCanvas;
    const ctx = perceptronCtx;
    
    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Positions
    const inputX = 80;
    const outputX = 320;
    const startY = 60;
    const spacing = 70;
    
    // Input values (normalized 0-1)
    const inputs = [
        { val: sunVal / 100, label: '‚òÄÔ∏è Sonne', y: startY, color: '#ffdd00' },
        { val: tempVal / 100, label: 'üå°Ô∏è Warm', y: startY + spacing, color: '#ff8c00' },
        { val: rainVal / 100, label: 'üåßÔ∏è Regen', y: startY + spacing * 2, color: '#00a8ff' }
    ];
    
    // Weights
    const weights = [3, 2, -5];
    
    // Output
    const outputY = startY + spacing;
    
    // Draw connections with weights
    for(let i = 0; i < 3; i++) {
        const weight = weights[i];
        const input = inputs[i];
        
        // Calculate line properties
        const isPositive = weight > 0;
        const strength = Math.abs(weight) / 5; // Normalize to 0-1
        const lineColor = isPositive ? '0, 243, 255' : '255, 0, 85'; // Blue for positive, red for negative
        const lineWidth = 1 + strength * 8;
        
        // Draw connection line
        ctx.strokeStyle = `rgba(${lineColor}, ${strength * 0.8})`;
        ctx.lineWidth = lineWidth;
        ctx.beginPath();
        ctx.moveTo(inputX + 30, input.y);
        ctx.lineTo(outputX - 30, outputY);
        ctx.stroke();
        
        // Draw weight value
        const midX = (inputX + outputX) / 2;
        const midY = (input.y + outputY) / 2;
        ctx.fillStyle = isPositive ? '#00f3ff' : '#ff0055';
        ctx.font = 'bold 12px monospace';
        ctx.fillText(`√ó${weight}`, midX - 15, midY - 5);
        
        // Draw calculation arrow
        const contribution = input.val * weight;
        ctx.fillStyle = '#888';
        ctx.font = '10px monospace';
        ctx.fillText(`=${Math.round(contribution)}`, midX - 10, midY + 10);
    }
    
    // Draw input neurons
    for(let i = 0; i < 3; i++) {
        const input = inputs[i];
        
        // Neuron circle
        const brightness = input.val;
        ctx.beginPath();
        ctx.arc(inputX, input.y, 25, 0, Math.PI * 2);
        
        // Fill with gradient based on activation
        const gradient = ctx.createRadialGradient(inputX - 8, input.y - 8, 5, inputX, input.y, 25);
        gradient.addColorStop(0, `rgba(${Math.floor(brightness * 255)}, ${Math.floor(brightness * 255)}, ${Math.floor(brightness * 255)}, 1)`);
        gradient.addColorStop(1, `rgba(${Math.floor(brightness * 150)}, ${Math.floor(brightness * 150)}, ${Math.floor(brightness * 150)}, 1)`);
        ctx.fillStyle = gradient;
        ctx.fill();
        
        // Border
        ctx.strokeStyle = brightness > 0.3 ? input.color : '#444';
        ctx.lineWidth = 3;
        ctx.stroke();
        
        // Glow effect for active neurons
        if(brightness > 0.3) {
            ctx.shadowColor = input.color;
            ctx.shadowBlur = 15;
            ctx.beginPath();
            ctx.arc(inputX, input.y, 25, 0, Math.PI * 2);
            ctx.stroke();
            ctx.shadowBlur = 0;
        }
        
        // Value text
        ctx.fillStyle = brightness > 0.5 ? '#000' : '#fff';
        ctx.font = 'bold 14px monospace';
        ctx.textAlign = 'center';
        ctx.fillText(Math.round(input.val * 100), inputX, input.y + 5);
        
        // Label
        ctx.fillStyle = '#ccc';
        ctx.font = '12px sans-serif';
        ctx.fillText(input.label, inputX, input.y + 45);
    }
    
    // Draw output neuron
    const outputActivation = decision === 'JA! üéâ' ? 1 : (decision === 'VIELLEICHT ü§î' ? 0.5 : 0);
    
    ctx.beginPath();
    ctx.arc(outputX, outputY, 30, 0, Math.PI * 2);
    
    // Color based on decision
    let outputColor;
    if(decision === 'JA! üéâ') {
        outputColor = '#00ff41';
    } else if(decision === 'NEIN! üòî') {
        outputColor = '#ff0055';
    } else {
        outputColor = '#ffdd00';
    }
    
    const gradient = ctx.createRadialGradient(outputX - 10, outputY - 10, 5, outputX, outputY, 30);
    gradient.addColorStop(0, outputColor);
    gradient.addColorStop(1, outputColor.replace(')', ', 0.5)').replace('rgb', 'rgba'));
    ctx.fillStyle = gradient;
    ctx.fill();
    
    // Border
    ctx.strokeStyle = outputColor;
    ctx.lineWidth = 4;
    ctx.stroke();
    
    // Glow
    ctx.shadowColor = outputColor;
    ctx.shadowBlur = 20;
    ctx.beginPath();
    ctx.arc(outputX, outputY, 30, 0, Math.PI * 2);
    ctx.stroke();
    ctx.shadowBlur = 0;
    
    // Output value
    ctx.fillStyle = '#000';
    ctx.font = 'bold 16px monospace';
    ctx.textAlign = 'center';
    ctx.fillText(Math.round(score), outputX, outputY + 6);
    
    // Label
    ctx.fillStyle = '#ccc';
    ctx.font = '14px sans-serif';
    ctx.fillText('AUSGABE', outputX, outputY + 50);
    
    // Decision text
    ctx.fillStyle = outputColor;
    ctx.font = 'bold 14px sans-serif';
    ctx.fillText(decision.split(' ')[0], outputX, outputY + 70);
    
    // Score display
    ctx.fillStyle = '#00f3ff';
    ctx.font = 'bold 16px monospace';
    ctx.textAlign = 'left';
    ctx.fillText(`Score: ${Math.round(score)}`, 20, 30);
    
    // Network labels
    ctx.fillStyle = '#00f3ff';
    ctx.font = 'bold 12px monospace';
    ctx.textAlign = 'center';
    ctx.fillText('EINGABE', inputX, 280);
    ctx.fillText('GEWICHTE', (inputX + outputX) / 2, 280);
    ctx.fillText('AUSGABE', outputX, 280);
}

function updatePerceptron() {
    let sun = parseInt(document.getElementById('sunInput').value);
    let temp = parseInt(document.getElementById('tempInput').value);
    let rain = parseInt(document.getElementById('rainInput').value);
    
    document.getElementById('sunVal').innerText = sun;
    document.getElementById('tempVal').innerText = temp;
    document.getElementById('rainVal').innerText = rain;
    
    let score = (sun * 3) + (temp * 2) - (rain * 5);
    
    let result = document.getElementById('perceptronResult');
    let explain = document.getElementById('perceptronExplain');
    
    let decision;
    if(score > 100) {
        decision = "JA! üéâ";
        result.style.color = "var(--green)";
        explain.innerText = "Score: " + score + " ‚Üí Super Wetter!";
    } else if(score > 0) {
        decision = "VIELLEICHT ü§î";
        result.style.color = "var(--yellow)";
        explain.innerText = "Score: " + score + " ‚Üí Geht so...";
    } else {
        decision = "NEIN! üòî";
        result.style.color = "var(--red)";
        explain.innerText = "Score: " + score + " ‚Üí Lieber drinnen!";
    }
    
    result.innerText = decision;
    
    // Draw the network visualization
    drawPerceptronNetwork(sun, temp, rain, score, decision);
}

function toggleSection(header) {
    const section = header.parentElement;
    section.classList.toggle('active');
}

function toggleAccordion(header) {
    const accordion = header.parentElement;
    accordion.classList.toggle('active');
}

setTimeout(updatePerceptron, 100);

// Initialize perceptron canvas
if(perceptronCanvas) {
    updatePerceptron();
}

// Initial load - IMMER mit Speed 1x starten!
const initialLoad = () => {
    document.getElementById('speedSlider').value = 1;
    document.getElementById('speedVal').innerText = "1x";
    gameRunning = true;  // Aktiviere Game Loop!
    initGame(); 
    loop();
};

birdImg.onload = initialLoad;
if(birdImg.complete) initialLoad();

</script>
</body>
</html>