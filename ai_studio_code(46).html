<!DOCTYPE html>
<html lang="de" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pixel 7 Neural Chat Pro</title>
    
    <!-- Externe Bibliotheken f√ºr UI, Markdown und Sicherheit -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>

    <style>
        /* Optimierungen f√ºr Mobile/Pixel */
        body { background-color: #0f172a; color: #e2e8f0; font-family: -apple-system, BlinkMacSystemFont, sans-serif; height: 100vh; overflow: hidden; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        /* Chat Styles */
        .prose { max-width: none; font-size: 0.95rem; line-height: 1.6; }
        .prose pre { background: #1e293b; padding: 10px; border-radius: 8px; overflow-x: auto; border: 1px solid #334155; }
        .prose code { background: #334155; padding: 2px 4px; border-radius: 4px; font-family: monospace; font-size: 0.85em; }
        .prose p { margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .msg-anim { animation: fadeIn 0.3s ease-out forwards; }
        
        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #3b82f6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }
    </style>
</head>
<body class="flex flex-col h-full">

    <!-- APP HEADER -->
    <header class="bg-slate-900 border-b border-slate-800 h-14 flex items-center justify-between px-4 shrink-0 z-20 shadow-md">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center shadow-lg">
                <i class="fas fa-brain text-white text-sm"></i>
            </div>
            <div>
                <h1 class="font-bold text-sm text-white tracking-wide">NeuralChat <span class="text-xs text-blue-400 font-normal">Pro</span></h1>
                <div class="flex items-center gap-1.5">
                    <span id="status-indicator" class="w-2 h-2 rounded-full bg-red-500"></span>
                    <span id="status-text" class="text-[10px] text-slate-400">Offline</span>
                </div>
            </div>
        </div>
        <button id="btn-settings" class="text-slate-400 hover:text-white transition p-2">
            <i class="fas fa-sliders-h"></i>
        </button>
    </header>

    <!-- MAIN CONTENT WRAPPER -->
    <div class="flex-1 flex overflow-hidden relative">
        
        <!-- SETTINGS SIDEBAR (Hidden by default on mobile) -->
        <aside id="sidebar" class="absolute inset-y-0 right-0 w-80 bg-slate-900 border-l border-slate-800 transform translate-x-full transition-transform duration-300 z-30 flex flex-col shadow-2xl">
            <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                <h2 class="font-bold text-sm">Einstellungen</h2>
                <button id="btn-close-settings" class="text-slate-400"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-4 overflow-y-auto flex-1 space-y-6">
                <!-- Model Config -->
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">System Prompt</label>
                    <textarea id="sys-prompt" rows="3" class="w-full bg-slate-800 text-xs text-slate-200 p-2 rounded border border-slate-700 focus:border-blue-500 outline-none">Du bist ein intelligenter Assistent. Antworte immer freundlich, pr√§zise und auf Deutsch.</textarea>
                </div>

                <!-- Parameters -->
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span>Kreativit√§t (Temp)</span>
                            <span id="val-temp" class="text-blue-400">0.6</span>
                        </div>
                        <input type="range" id="rng-temp" min="0.1" max="1.5" step="0.1" value="0.6" class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span>Kontext-L√§nge</span>
                            <span id="val-ctx" class="text-blue-400">1024</span>
                        </div>
                        <input type="range" id="rng-ctx" min="512" max="2048" step="256" value="1024" class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>

                <!-- Tools -->
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Werkzeuge</label>
                    <button id="btn-reset-cache" class="w-full bg-red-900/30 text-red-400 border border-red-900 hover:bg-red-900/50 text-xs py-2 rounded mb-2 transition">
                        <i class="fas fa-trash mr-2"></i> Cache & Modell l√∂schen
                    </button>
                    <div class="text-[10px] text-slate-600 text-center">Version 2.0 ‚Ä¢ Powered by ü§ó Transformers.js</div>
                </div>
            </div>
        </aside>

        <!-- CHAT AREA -->
        <main class="flex-1 flex flex-col relative w-full bg-slate-950">
            
            <!-- Chat History -->
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6 pb-20">
                <!-- Welcome -->
                <div class="flex flex-col items-center justify-center mt-10 opacity-70">
                    <div class="p-4 bg-slate-900 rounded-2xl border border-slate-800 mb-4 shadow-xl">
                        <i class="fas fa-microchip text-4xl text-blue-500"></i>
                    </div>
                    <h2 class="text-lg font-bold">Bereit f√ºr den Start</h2>
                    <p class="text-xs text-slate-500 max-w-[250px] text-center mt-2">
                        Das Modell wird lokal in den Browser geladen. Keine Daten verlassen dein Ger√§t.
                    </p>
                    <button id="btn-start-engine" class="mt-6 bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-full font-bold shadow-lg shadow-blue-900/20 transition transform hover:scale-105">
                        Modell Laden (ca. 400MB)
                    </button>
                    
                    <!-- Progress Bar (Hidden initially) -->
                    <div id="loading-ui" class="hidden w-64 mt-6">
                        <div class="flex justify-between text-xs text-slate-400 mb-1">
                            <span id="load-status">Initialisiere...</span>
                            <span id="load-pct">0%</span>
                        </div>
                        <div class="h-2 bg-slate-800 rounded-full overflow-hidden">
                            <div id="progress-bar" class="h-full bg-blue-500 w-0 transition-all duration-300"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RAG Context Bar -->
            <div id="rag-bar" class="bg-slate-900/80 backdrop-blur border-t border-slate-800 px-4 py-2 flex items-center justify-between text-xs hidden">
                <div class="flex items-center gap-2 text-slate-400">
                    <i class="fas fa-book text-blue-400"></i>
                    <span id="rag-info">0 Dokumente aktiv</span>
                </div>
                <input type="file" id="file-upload" multiple class="hidden" accept=".txt,.md,.json">
                <button onclick="document.getElementById('file-upload').click()" class="text-blue-400 hover:text-white font-bold">
                    + Upload
                </button>
            </div>

            <!-- Input Area -->
            <div class="p-3 bg-slate-900 border-t border-slate-800 pb-safe">
                <div class="max-w-4xl mx-auto flex items-end gap-2 bg-slate-800 p-1.5 rounded-2xl border border-slate-700 focus-within:border-blue-500 focus-within:ring-1 focus-within:ring-blue-500/50 transition-all">
                    
                    <textarea id="user-input" rows="1" disabled placeholder="Warte auf System..." 
                        class="w-full bg-transparent text-slate-100 text-sm px-3 py-2.5 outline-none resize-none max-h-32 placeholder-slate-500"
                        style="min-height: 44px;"></textarea>
                    
                    <button id="btn-send" disabled class="bg-blue-600 text-white w-10 h-10 rounded-xl flex items-center justify-center shadow-lg disabled:opacity-50 disabled:bg-slate-700 transition-all flex-shrink-0 mb-0.5">
                        <i class="fas fa-paper-plane text-xs"></i>
                    </button>
                </div>
                <div class="text-[9px] text-center text-slate-600 mt-2">
                    Lokal ausgef√ºhrt auf Pixel 7 ‚Ä¢ Qwen 2.5 0.5B (WASM)
                </div>
            </div>
        </main>
    </div>

    <!-- WORKER SCRIPT (The Brain) -->
    <script id="worker-code" type="javascript/worker">
        import { pipeline, env, TextStreamer } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.0.2';

        // --- KONFIGURATION F√úR STABILIT√ÑT ---
        env.allowLocalModels = false;
        env.useBrowserCache = true; 
        env.backends.onnx.wasm.numThreads = 4; // Pixel 7 Sweetspot
        env.backends.onnx.wasm.simd = true;

        class RAGSystem {
            constructor() {
                this.chunks = [];
            }

            addDocument(filename, text) {
                // Intelligenteres Chunking mit Overlap
                const chunkSize = 500;
                const overlap = 100;
                
                // Einfaches Splitting (in Prod w√ºrde man Sentence-Splitter nutzen)
                const words = text.split(/\s+/);
                
                for (let i = 0; i < words.length; i += (chunkSize - overlap)) {
                    const chunkText = words.slice(i, i + chunkSize).join(' ');
                    if (chunkText.length < 50) continue; // Zu kurz ignorieren
                    
                    this.chunks.push({
                        id: Math.random().toString(36),
                        text: chunkText,
                        source: filename,
                        // Simulierter Embedding-Vektor (hier nur Keywords f√ºr Performance)
                        keywords: new Set(chunkText.toLowerCase().split(/\s+/).filter(w => w.length > 4))
                    });
                }
                return this.chunks.length;
            }

            search(query, limit = 3) {
                if (this.chunks.length === 0) return [];
                
                const queryTerms = query.toLowerCase().split(/\s+/).filter(w => w.length > 3);
                
                // Scoring basierend auf Keyword-Overlap (Jaccard-√§hnlich)
                const scored = this.chunks.map(chunk => {
                    let hits = 0;
                    queryTerms.forEach(term => {
                        if (chunk.keywords.has(term) || chunk.text.toLowerCase().includes(term)) hits++;
                    });
                    // Bonus f√ºr exakte Phrasen k√∂nnte hier hin
                    return { ...chunk, score: hits };
                });

                return scored
                    .filter(s => s.score > 0)
                    .sort((a, b) => b.score - a.score)
                    .slice(0, limit);
            }
        }

        let pipelineInstance = null;
        let tokenizer = null;
        const rag = new RAGSystem();

        self.onmessage = async (e) => {
            const { type, data } = e.data;

            if (type === 'init') {
                try {
                    const modelId = 'onnx-community/Qwen2.5-0.5B-Instruct';
                    
                    self.postMessage({ type: 'status', text: 'Lade Tokenizer...' });
                    
                    pipelineInstance = await pipeline('text-generation', modelId, {
                        dtype: 'q4',
                        device: 'wasm',
                        progress_callback: (p) => self.postMessage({ type: 'progress', data: p })
                    });
                    
                    // Tokenizer extrahieren f√ºr Chat-Templates
                    tokenizer = pipelineInstance.tokenizer;

                    self.postMessage({ type: 'ready' });
                } catch (err) {
                    self.postMessage({ type: 'error', msg: err.message });
                }
            }

            if (type === 'ingest') {
                const count = rag.addDocument(data.filename, data.content);
                self.postMessage({ type: 'rag_update', count: rag.chunks.length });
            }

            if (type === 'generate') {
                if (!pipelineInstance) return;

                const { messages, config } = data;
                const lastMsg = messages[messages.length - 1].content;

                // 1. RAG Search
                const contextDocs = rag.search(lastMsg);
                let contextText = "";
                if (contextDocs.length > 0) {
                    contextText = contextDocs.map(d => `[Quelle: ${d.source}]\n${d.text}`).join("\n\n");
                    // System Prompt modifizieren
                    messages[0].content += `\n\nNutze folgende Informationen:\n${contextText}`;
                }

                // 2. Chat Template anwenden (Manuell oder via Tokenizer)
                // Qwen nutzt ChatML
                let fullPrompt = "";
                messages.forEach(m => {
                    fullPrompt += `<|im_start|>${m.role}\n${m.content}<|im_end|>\n`;
                });
                fullPrompt += "<|im_start|>assistant\n";

                try {
                    const streamer = new TextStreamer(tokenizer, {
                        skip_prompt: true,
                        skip_special_tokens: true,
                        callback_function: (token) => {
                            self.postMessage({ type: 'token', text: token });
                        }
                    });

                    await pipelineInstance(fullPrompt, {
                        max_new_tokens: parseInt(config.maxTokens) || 512,
                        temperature: parseFloat(config.temp) || 0.6,
                        do_sample: true,
                        repetition_penalty: 1.1,
                        streamer: streamer
                    });

                    self.postMessage({ type: 'done', sources: contextDocs });

                } catch (err) {
                    self.postMessage({ type: 'error', msg: err.message });
                }
            }
        };
    </script>

    <!-- MAIN APP LOGIC -->
    <script>
        // --- UI REFERENZEN ---
        const UI = {
            btnStart: document.getElementById('btn-start-engine'),
            loadingUi: document.getElementById('loading-ui'),
            pBar: document.getElementById('progress-bar'),
            pText: document.getElementById('load-pct'),
            statusText: document.getElementById('load-status'),
            chat: document.getElementById('chat-container'),
            input: document.getElementById('user-input'),
            btnSend: document.getElementById('btn-send'),
            ragInfo: document.getElementById('rag-info'),
            ragBar: document.getElementById('rag-bar'),
            settingsPanel: document.getElementById('sidebar'),
            statusDot: document.getElementById('status-indicator'),
            statusLabel: document.getElementById('status-text'),
            
            // Settings
            sysPrompt: document.getElementById('sys-prompt'),
            rngTemp: document.getElementById('rng-temp'),
            valTemp: document.getElementById('val-temp'),
            rngCtx: document.getElementById('rng-ctx'),
            valCtx: document.getElementById('val-ctx')
        };

        // --- STATE MANAGEMENT ---
        const State = {
            worker: null,
            history: [], // [{role: 'user', content: '...'}, ...]
            isGenerating: false,
            docsCount: 0
        };

        // --- WORKER SETUP ---
        const workerBlob = new Blob([document.getElementById('worker-code').textContent], { type: 'text/javascript' });
        State.worker = new Worker(URL.createObjectURL(workerBlob), { type: 'module' });

        // --- EVENT HANDLER ---

        // 1. Initialisierung
        UI.btnStart.onclick = () => {
            UI.btnStart.classList.add('hidden');
            UI.loadingUi.classList.remove('hidden');
            UI.statusDot.className = "w-2 h-2 rounded-full bg-yellow-500 animate-pulse";
            UI.statusLabel.textContent = "Lade...";
            State.worker.postMessage({ type: 'init' });
        };

        // 2. Nachricht senden
        const sendMessage = () => {
            const text = UI.input.value.trim();
            if (!text || State.isGenerating) return;

            // UI Updates
            UI.input.value = '';
            UI.input.style.height = 'auto';
            UI.input.disabled = true;
            UI.btnSend.disabled = true;
            State.isGenerating = true;

            // Add User Message to History & UI
            const userMsg = { role: 'user', content: text };
            State.history.push(userMsg);
            appendMessage('user', text);

            // Create AI Placeholder
            const aiDiv = appendMessage('assistant', '<span class="animate-pulse">Denke nach...</span>');
            
            // Prepare context (limit history to last 6 messages to save RAM)
            const contextWindow = State.history.slice(-6);
            // Inject current System Prompt
            if (contextWindow[0].role !== 'system') {
                contextWindow.unshift({ role: 'system', content: UI.sysPrompt.value });
            } else {
                contextWindow[0].content = UI.sysPrompt.value;
            }

            State.worker.postMessage({
                type: 'generate',
                data: {
                    messages: contextWindow,
                    config: {
                        temp: UI.rngTemp.value,
                        maxTokens: 512 // Limit for speed on mobile
                    }
                }
            });

            State.currentAiDiv = aiDiv;
            State.currentAiText = "";
        };

        // 3. Worker Antworten verarbeiten
        State.worker.onmessage = (e) => {
            const { type, data, text, msg, count, sources } = e.data;

            if (type === 'progress') {
                if (data.status === 'progress') {
                    const pct = Math.round(data.progress * 100);
                    UI.pBar.style.width = `${pct}%`;
                    UI.pText.textContent = `${pct}%`;
                } else if (data.status === 'done') {
                    UI.statusText.textContent = "Verarbeite...";
                }
            }

            if (type === 'ready') {
                // Remove Loading UI, show Chat
                UI.chat.innerHTML = ''; // Clear Welcome
                UI.ragBar.classList.remove('hidden');
                UI.input.disabled = false;
                UI.btnSend.disabled = false;
                UI.input.placeholder = "Nachricht eingeben...";
                UI.statusDot.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]";
                UI.statusLabel.textContent = "Online (CPU)";
                appendSystemMessage("System bereit. Qwen 2.5 0.5B geladen.");
            }

            if (type === 'token') {
                State.currentAiText += text;
                // Render Markdown on every token is expensive, so just raw text first
                // Or simplified rendering. Here we do raw text + basic format for speed
                State.currentAiDiv.innerHTML = DOMPurify.sanitize(marked.parse(State.currentAiText));
                scrollToBottom();
            }

            if (type === 'done') {
                State.history.push({ role: 'assistant', content: State.currentAiText });
                State.isGenerating = false;
                UI.input.disabled = false;
                UI.btnSend.disabled = false;
                UI.input.focus();
                
                // Show RAG Sources if used
                if (sources && sources.length > 0) {
                    const sourceHTML = sources.map(s => `<span class="bg-slate-800 px-2 py-1 rounded text-[10px] border border-slate-700">${s.source}</span>`).join(' ');
                    const footer = document.createElement('div');
                    footer.className = "mt-2 flex gap-1 flex-wrap opacity-70";
                    footer.innerHTML = `Sources: ${sourceHTML}`;
                    State.currentAiDiv.appendChild(footer);
                }
            }

            if (type === 'error') {
                alert("Fehler: " + msg);
                State.isGenerating = false;
                UI.input.disabled = false;
            }

            if (type === 'rag_update') {
                State.docsCount = count;
                UI.ragInfo.textContent = `${count} Chunks im Speicher`;
                appendSystemMessage(`Dokument indexiert. ${count} Textbausteine verf√ºgbar.`);
            }
        };

        // --- HELPER FUNCTIONS ---

        function appendMessage(role, html) {
            const div = document.createElement('div');
            div.className = `flex w-full msg-anim ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            bubble.className = role === 'user' 
                ? "bg-blue-600 text-white rounded-2xl rounded-tr-none px-4 py-3 max-w-[85%] shadow-md prose prose-invert"
                : "bg-slate-800 text-slate-200 border border-slate-700 rounded-2xl rounded-tl-none px-4 py-3 max-w-[90%] shadow-md prose prose-invert";
            
            bubble.innerHTML = role === 'user' ? html : DOMPurify.sanitize(marked.parse(html || ''));
            
            div.appendChild(bubble);
            UI.chat.appendChild(div);
            scrollToBottom();
            return bubble;
        }

        function appendSystemMessage(text) {
            const div = document.createElement('div');
            div.className = "text-center text-[10px] text-slate-500 my-2";
            div.textContent = text;
            UI.chat.appendChild(div);
            scrollToBottom();
        }

        function scrollToBottom() {
            UI.chat.scrollTop = UI.chat.scrollHeight;
        }

        // --- UI BINDINGS ---
        
        // Auto-Resize Input
        UI.input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // Send Keys
        UI.btnSend.onclick = sendMessage;
        UI.input.onkeydown = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        };

        // Settings Toggle
        document.getElementById('btn-settings').onclick = () => UI.settingsPanel.classList.remove('translate-x-full');
        document.getElementById('btn-close-settings').onclick = () => UI.settingsPanel.classList.add('translate-x-full');

        // Sliders
        UI.rngTemp.oninput = (e) => UI.valTemp.textContent = e.target.value;
        UI.rngCtx.oninput = (e) => UI.valCtx.textContent = e.target.value;

        // Reset Cache
        document.getElementById('btn-reset-cache').onclick = async () => {
            if(confirm("ACHTUNG: Dies l√∂scht das heruntergeladene Modell (500MB+). Fortfahren?")) {
                const keys = await caches.keys();
                keys.forEach(key => caches.delete(key));
                location.reload();
            }
        };

        // File Upload
        document.getElementById('file-upload').onchange = async (e) => {
            const files = Array.from(e.target.files);
            for (const file of files) {
                const text = await file.text();
                State.worker.postMessage({ type: 'ingest', data: { filename: file.name, content: text } });
            }
        };

    </script>
</body>
</html>